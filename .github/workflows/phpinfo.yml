name: PHP Info Page

on:
  push:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *" # æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡ï¼ˆUTCï¼‰

jobs:
  phpinfo:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”„ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ“¦ Download run count artifact
        uses: actions/download-artifact@v3
        with:
          name: run-count
        continue-on-error: true # ç¬¬ä¸€æ¬¡åŸ·è¡Œæ™‚ artifact ä¸å­˜åœ¨

      - name: ğŸ§® Check and update run count
        id: runcheck
        run: |
          COUNT_FILE=run-count.txt
          if [ -f "$COUNT_FILE" ]; then
            COUNT=$(cat "$COUNT_FILE")
          else
            COUNT=0
          fi

          echo "ç›®å‰åŸ·è¡Œæ¬¡æ•¸ï¼š$COUNT"
          if [ "$COUNT" -ge 2 ]; then
            echo "å·²åŸ·è¡Œå…©æ¬¡ï¼Œè·³éæµç¨‹ã€‚"
            exit 0
          fi

          COUNT=$((COUNT + 1))
          echo "$COUNT" > "$COUNT_FILE"
          echo "run_count=$COUNT" >> $GITHUB_OUTPUT

      - name: ğŸ§° Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: ğŸ“„ Create phpinfo page
        run: |
          mkdir -p public
          echo "<?php phpinfo(); ?>" > public/index.php

      - name: ğŸš€ Start PHP built-in server
        run: |
          php -S localhost:8000 -t public &
          sleep 2

      - name: ğŸ” Test phpinfo page
        run: |
          curl -s http://localhost:8000 | grep -i "php version"

      - name: ğŸ“¤ Upload updated run count
        if: steps.runcheck.outputs.run_count != '2'
        uses: actions/upload-artifact@v3
        with:
          name: run-count
          path: run-count.txt
